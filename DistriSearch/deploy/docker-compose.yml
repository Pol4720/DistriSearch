version: '3.8'

services:
  # DHT Service (Distributed Hash Table)
  dht:
    build:
      context: ../../DHT
      dockerfile: Dockerfile
    container_name: distrisearch-dht
    ports:
      - "8080:8080"  # HTTP API (Flask)
      - "2000:2000"  # Peer P2P Socket
    environment:
      - PORT=2000
      - MAX_BITS=10
    networks:
      - distrisearch_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/server/rest/DHT/imprimirSucPred', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # API Backend
  backend:
    build: 
      context: ../backend
    ports:
      - "8000:8000"
      # Para HTTPS, usa 8443 (descomenta la siguiente línea y ajusta en .env)
      - "8443:8443"
    volumes:
      - backend_data:/app/data
      - ../../central_shared:/app/central_shared
      # Montar certificados SSL (crea la carpeta ../certs primero)
      - ../../certs:/app/certs:ro
    environment:
      - ENVIRONMENT=development
      - CENTRAL_SHARED_FOLDER=/app/central_shared
      - CENTRAL_AUTO_SCAN=true
      - DATABASE_PATH=/app/data/distrisearch.db
      # Configuración SSL/TLS
      - ENABLE_SSL=${ENABLE_SSL:-false}
      - SSL_CERT_FILE=/app/certs/distrisearch.crt
      - SSL_KEY_FILE=/app/certs/distrisearch.key
      # Configuración de red externa
      - PUBLIC_URL=${PUBLIC_URL:-http://localhost:8000}
      - EXTERNAL_IP=${EXTERNAL_IP:-}
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=${BACKEND_PORT:-8000}
      # Seguridad
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      # DHT Configuration
      - DHT_AUTO_START=${DHT_AUTO_START:-true}
      - DHT_MODE=${DHT_MODE:-external}
      - DHT_HTTP_URL=${DHT_HTTP_URL:-http://dht:8080}
      - DHT_PORT=2000
      - DHT_SEED_IP=${DHT_SEED_IP:-}
      - DHT_SEED_PORT=${DHT_SEED_PORT:-2000}
    depends_on:
      - dht
    networks:
      - distrisearch_network
    restart: unless-stopped

  # Frontend Streamlit
  frontend:
    build:
      context: ../frontend
    ports:
      - "8501:8501"
    environment:
      - DISTRISEARCH_BACKEND_URL=${DISTRISEARCH_BACKEND_URL:-http://backend:8000}
      - DISTRISEARCH_BACKEND_PUBLIC_URL=${DISTRISEARCH_BACKEND_PUBLIC_URL:-http://localhost:8000}
      - DISTRISEARCH_ADMIN_API_KEY=${DISTRISEARCH_ADMIN_API_KEY:-}
    depends_on:
      - backend
    networks:
      - distrisearch_network
    restart: unless-stopped

  # Agente 1
  agent1:
    build:
      context: ../agent
    volumes:
      - ./shared_folders/agent1:/app/shared
      - ./agent_configs/agent1.yaml:/app/config.yaml
      # Montar certificados SSL para el agente
      - ../../certs:/app/certs:ro
    environment:
      - NODE_ID=node1
      - NODE_NAME=Agente 1
      - BACKEND_URL=${BACKEND_URL:-http://backend:8000}
      - FILE_SERVER_PORT=8081
      # SSL para agente
      - AGENT_SSL_ENABLED=${AGENT_SSL_ENABLED:-false}
      - AGENT_SSL_CERT_FILE=/app/certs/distrisearch.crt
      - AGENT_SSL_KEY_FILE=/app/certs/distrisearch.key
      - VERIFY_SSL=${VERIFY_SSL:-false}
    ports:
      - "8081:8081"
    depends_on:
      - backend
    networks:
      - distrisearch_network
    restart: unless-stopped

  # Agente 2
  agent2:
    build:
      context: ../agent
    volumes:
      - ./shared_folders/agent2:/app/shared
      - ./agent_configs/agent2.yaml:/app/config.yaml
      # Montar certificados SSL para el agente
      - ../../certs:/app/certs:ro
    environment:
      - NODE_ID=node2
      - NODE_NAME=Agente 2
      - BACKEND_URL=${BACKEND_URL:-http://backend:8000}
      - FILE_SERVER_PORT=8082
      # SSL para agente
      - AGENT_SSL_ENABLED=${AGENT_SSL_ENABLED:-false}
      - AGENT_SSL_CERT_FILE=/app/certs/distrisearch.crt
      - AGENT_SSL_KEY_FILE=/app/certs/distrisearch.key
      - VERIFY_SSL=${VERIFY_SSL:-false}
    ports:
      - "8082:8082"
    depends_on:
      - backend
    networks:
      - distrisearch_network
    restart: unless-stopped

volumes:
  backend_data:

networks:
  distrisearch_network:
    driver: bridge
